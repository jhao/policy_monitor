# 政策监控平台

本项目实现了一个可配置的政策信息监控平台，包含基础的站点配置、关注内容管理、监控任务执行与结果归档等功能，适合部署在轻量级服务器上进行日常监测。

## 功能概览

- **关注网站管理**：配置站点名称、入口 URL、是否抓取子页面、抓取时间间隔以及最后一次抓取时间，支持增删改查。
- **关注内容清单**：维护需要重点关注的内容摘要（每条不超过 50 个字符），可用于多任务复用。
- **监控任务管理**：绑定关注站点和关注内容，配置通知邮箱，支持启动/暂停任务，并展示最近执行日志及状态。
- **监控结果归档**：记录每次抓取的匹配内容，支持按任务、站点、关注内容及时间范围筛选，并提供分页浏览。
- **自动抓取与通知**：随服务启动自动运行调度器，按网站配置的时间间隔抓取页面，比较页面增量链接，利用 BERT 语义相似度筛选内容并通过 SMTP 邮件发送提醒，同时完整记录执行日志。

## 技术栈

- 前端：Flask + Jinja2 模板 + Bootstrap 5（无需复杂构建工具，便于维护与阅读）。
- 后端：Python 3、Flask、SQLAlchemy。
- 数据库：SQLite，默认存储在项目根目录的 `data.db`。
- NLP：使用 `sentence-transformers` 的 `all-MiniLM-L6-v2` 模型计算关注内容与网页摘要的大意相似度。
- 定时任务：内置后台线程调度，根据任务关联的网站抓取频率执行。

## 快速开始

1. **安装依赖**

   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows 使用 .venv\Scripts\activate
   pip install -r requirements.txt
   ```

2. **配置 SMTP**

   运行前请在环境变量或 `app.py` 中配置以下参数：

   - `SMTP_HOST`
   - `SMTP_PORT`
   - `SMTP_USERNAME`
   - `SMTP_PASSWORD`
   - `SMTP_USE_TLS`（可选，默认为 `true`）
   - `SMTP_SENDER`（可选，默认与用户名一致）

3. **启动服务**

   ```bash
   flask --app app run
   ```

   首次启动会自动初始化数据库并启动监控调度器。

4. **访问平台**

   浏览器打开 `http://localhost:5000`，即可进行站点、关注内容、监控任务的配置与管理。

## 工作原理

1. 调度器按照配置的时间间隔触发监控任务，抓取站点首页 HTML。
2. 将最新 HTML 与站点上一次的快照对比，找出新增链接（可根据配置决定是否处理子页面）。
3. 对新增链接逐一抓取，提取标题与正文摘要。
4. 使用 BERT 模型计算摘要与关注内容的语义相似度，超过 0.6 即视为命中。
5. 命中后保存结果记录，并通过邮件推送标题、链接和摘要；所有步骤均写入执行日志，便于排查。

## 注意事项

- `sentence-transformers` 首次运行会下载预训练模型，需要能够访问 HuggingFace Hub。
- 如果站点页面结构复杂，可根据实际情况在 `crawler.py` 中扩展解析与差异检测逻辑。
- 默认示例 SMTP 配置仅为占位，请务必使用真实的邮件服务账号。

## 目录结构

```
.
├── app.py                # Flask 应用入口及路由
├── crawler.py            # 抓取、对比与通知逻辑
├── database.py           # 数据库初始化与会话管理
├── email_utils.py        # SMTP 邮件发送封装
├── models.py             # SQLAlchemy 数据模型
├── nlp.py                # BERT 语义相似度工具
├── scheduler.py          # 后台任务调度
├── templates/            # 页面模板
├── requirements.txt      # 依赖列表
└── data.db               # 运行后生成的 SQLite 数据库
```

## 开发与扩展建议

- 可按需将后台调度改造为 APScheduler 或 Celery，以便水平扩展与错峰执行。
- 邮件通知可替换为企业微信、钉钉或短信等渠道，仅需在 `notify` 函数内调整实现。
- 若需更精细的差异检测，可将站点快照存储为结构化数据并结合 diff 算法分析。

欢迎根据业务需求进行二次开发与部署。
