{% extends 'base.html' %}
{% block content %}
<h2>{{ '编辑网站' if website else '新增网站' }}</h2>
<form method="post" class="mt-3">
  <div class="mb-3">
    <label class="form-label">网站名称</label>
    <input type="text" class="form-control" name="name" required value="{{ website.name if website else '' }}">
  </div>
  <div class="mb-3">
    <label class="form-label">URL</label>
    <input type="url" class="form-control" name="url" required value="{{ website.url if website else '' }}">
  </div>
  <div class="mb-3">
    <label class="form-label">抓取时间间隔(分钟)</label>
    <input type="number" class="form-control" name="interval" min="1" value="{{ website.interval_minutes if website else 60 }}">
  </div>

  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light fw-semibold">访问控制</div>
    <div class="card-body">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" name="use_proxy" id="useProxy" {% if website and website.use_proxy %}checked{% endif %}>
        <label class="form-check-label" for="useProxy">启用代理抓取</label>
      </div>
      <div id="proxyAdvanced" class="row g-3 align-items-end{% if not (website and website.use_proxy) %} d-none{% endif %}">
        <div class="col-md-4">
          <label class="form-label">请求间隔(秒)</label>
          <input type="number" class="form-control" name="proxy_request_interval" min="0" step="1" value="{{ website.proxy_request_interval if website else 0 }}">
          <div class="form-text">每次请求之间的最小等待时间，建议设置为 1 秒或以上以降低触发风控风险。</div>
        </div>
        <div class="col-md-8">
          <label class="form-label">自定义 User-Agent</label>
          <input type="text" class="form-control" name="proxy_user_agent" placeholder="留空时自动轮换常见浏览器 UA" value="{{ website.proxy_user_agent if website and website.proxy_user_agent else '' }}">
          <div class="form-text">当目标网站需要特定的客户端标识时可填写，否则建议留空使用系统随机分配。</div>
        </div>
      </div>
    </div>
  </div>

  <div class="form-check form-switch mb-4">
    <input class="form-check-input" type="checkbox" name="is_json_api" id="isJsonApi" {% if website and website.is_json_api %}checked{% endif %}>
    <label class="form-check-label" for="isJsonApi">使用 JSON API 列表数据</label>
  </div>

  <div id="listConfig" class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light fw-semibold">列表页配置</div>
    <div class="card-body">
      <div class="mb-3 mb-md-0">
        <label class="form-label d-flex flex-wrap align-items-center gap-2">内容采集区域定位
          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#contentAreaHelpModal">填写说明</button>
        </label>
        <textarea class="form-control" name="content_area_selectors" rows="3" placeholder="例如：css=#main .article-list 或 xpath=//section[@data-type='policy']">{{ website.content_area_selector_config if website and website.content_area_selector_config else '' }}</textarea>
        <div class="form-text">每行一条规则，与标题和正文定位的写法一致，按顺序匹配第一个找到的区域。</div>
      </div>
    </div>
  </div>

  <div id="detailConfig" class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light fw-semibold">详情页配置</div>
    <div class="card-body">
      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" name="fetch_subpages" id="fetchSubpages" {% if website and website.fetch_subpages %}checked{% endif %}>
        <label class="form-check-label" for="fetchSubpages">需要抓取子页面</label>
      </div>
      <div id="detailSelectors" class="detail-selectors{% if not (website and website.fetch_subpages) %} d-none{% endif %}">
        <div class="mb-3">
          <label class="form-label">标题元素描述</label>
          <textarea class="form-control" name="title_selectors" rows="3" placeholder="例如：id=main-title 或 css=h1.article-title">{{ website.title_selector_config if website and website.title_selector_config else '' }}</textarea>
          <div class="form-text">每行一条规则，支持 <code>id=</code>、<code>class=</code>、<code>name=</code>、<code>css=</code>、<code>xpath=</code> 等写法，按顺序优先匹配。</div>
        </div>
        <div class="mb-0">
          <label class="form-label">正文元素描述</label>
          <textarea class="form-control" name="content_selectors" rows="4" placeholder="例如：css=article .content 或 xpath=//div[@id='detail']">{{ website.content_selector_config if website and website.content_selector_config else '' }}</textarea>
          <div class="form-text">若能匹配到对应元素，将直接使用其文本作为页面标题或正文；未匹配到时将自动回退到智能摘要，并忽略菜单及页脚文字。</div>
        </div>
      </div>
    </div>
  </div>

  <div id="jsonApiConfig" class="card border-0 shadow-sm mb-4{% if not (website and website.is_json_api) %} d-none{% endif %}">
    <div class="card-header bg-light fw-semibold">JSON API 配置</div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">数据列表路径</label>
        <input type="text" class="form-control" name="api_list_path" placeholder="例如：data.items 或 records" value="{{ website.api_list_path if website and website.api_list_path else '' }}">
        <div class="form-text">按点号分隔的路径，可使用如 <code>data.items[0]</code> 的下标访问，留空表示直接使用顶层数组。</div>
      </div>
      <div class="mb-3">
        <label class="form-label">标题字段路径</label>
        <input type="text" class="form-control" name="api_title_path" placeholder="例如：title 或 attributes.name" value="{{ website.api_title_path if website and website.api_title_path else '' }}">
        <div class="form-text">用于提取子页面标题的字段路径，支持点号与下标语法，留空则默认使用拼接后的链接作为标题。</div>
      </div>
      <div class="mb-3">
        <label class="form-label">URL 字段路径</label>
        <input type="text" class="form-control" name="api_url_path" placeholder="例如：detailUrl 或 data.id" value="{{ website.api_url_path if website and website.api_url_path else '' }}">
        <div class="form-text">当未配置 URL 模板时，系统将读取该字段作为链接地址。</div>
      </div>
      <div class="mb-3">
        <label class="form-label">URL 模板</label>
        <input type="text" class="form-control" name="api_url_template" placeholder="例如：https://example.com/detail/{id}" value="{{ website.api_url_template if website and website.api_url_template else '' }}">
        <div class="form-text">可使用 <code>{字段路径}</code> 语法引用列表项字段，例如 <code>{data.id}</code>。若模板返回相对路径，将自动与下方基准地址或网站 URL 拼接。</div>
      </div>
      <div class="mb-0">
        <label class="form-label">详情页基准地址</label>
        <input type="text" class="form-control" name="api_detail_url_base" placeholder="例如：https://example.com/" value="{{ website.api_detail_url_base if website and website.api_detail_url_base else '' }}">
        <div class="form-text">当生成的链接为相对路径时，将使用该地址作为基准；留空时默认使用网站 URL。</div>
      </div>
    </div>
  </div>

  <button class="btn btn-primary" type="submit">保存</button>
  <a class="btn btn-secondary" href="{{ url_for('list_websites') }}">返回</a>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var fetchSubpagesCheckbox = document.getElementById('fetchSubpages');
    var detailSelectors = document.getElementById('detailSelectors');
    var isJsonApiCheckbox = document.getElementById('isJsonApi');
    var jsonApiConfig = document.getElementById('jsonApiConfig');
    var listConfig = document.getElementById('listConfig');
    var detailConfig = document.getElementById('detailConfig');
    var useProxyCheckbox = document.getElementById('useProxy');
    var proxyAdvanced = document.getElementById('proxyAdvanced');
    var apiTitlePathInput = document.querySelector('input[name="api_title_path"]');

    function hasApiTitlePath() {
      return isJsonApiCheckbox.checked && apiTitlePathInput && apiTitlePathInput.value.trim() !== '';
    }

    function toggleDetailSelectors() {
      if (isJsonApiCheckbox.checked) {
        if (hasApiTitlePath()) {
          detailSelectors.classList.add('d-none');
        } else {
          detailSelectors.classList.remove('d-none');
        }
        return;
      }

      if (fetchSubpagesCheckbox.checked) {
        detailSelectors.classList.remove('d-none');
      } else {
        detailSelectors.classList.add('d-none');
      }
    }

    function toggleJsonApiConfig() {
      if (isJsonApiCheckbox.checked) {
        jsonApiConfig.classList.remove('d-none');
        listConfig.classList.add('d-none');
        if (hasApiTitlePath()) {
          detailConfig.classList.add('d-none');
        } else {
          detailConfig.classList.remove('d-none');
        }
      } else {
        jsonApiConfig.classList.add('d-none');
        listConfig.classList.remove('d-none');
        detailConfig.classList.remove('d-none');
      }
      toggleDetailSelectors();
    }

    function toggleProxyConfig() {
      if (useProxyCheckbox.checked) {
        proxyAdvanced.classList.remove('d-none');
      } else {
        proxyAdvanced.classList.add('d-none');
      }
    }

    toggleDetailSelectors();
    toggleJsonApiConfig();
    toggleProxyConfig();
    fetchSubpagesCheckbox.addEventListener('change', toggleDetailSelectors);
    isJsonApiCheckbox.addEventListener('change', toggleJsonApiConfig);
    useProxyCheckbox.addEventListener('change', toggleProxyConfig);
    if (apiTitlePathInput) {
      apiTitlePathInput.addEventListener('input', function () {
        toggleJsonApiConfig();
      });
    }
  });
</script>

<div class="modal fade" id="contentAreaHelpModal" tabindex="-1" aria-labelledby="contentAreaHelpModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contentAreaHelpModalLabel">内容采集区域定位填写说明</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">内容采集区域用于限定爬虫分析的网页范围。每行写一条定位规则，系统会按顺序尝试，命中后即使用该区域。支持以下写法：</p>
        <ul>
          <li><strong>通过 <code>class</code> 定位：</strong> <code>class=main-content</code> 表示选择第一个 <code>class="main-content"</code> 的区域；如需多层嵌套，可写 <code>css=.main-content .list-wrapper</code>。</li>
          <li><strong>通过标签(Tag)定位：</strong> <code>css=article</code> 或 <code>css=section.news-area</code> 可直接根据标签或标签组合限定区域。</li>
          <li><strong>通过 <code>id</code> 定位：</strong> <code>id=primary</code> 会定位到 <code>id="primary"</code> 的块，常用于唯一的主体容器。</li>
          <li><strong>通过 <code>name</code> 定位：</strong> <code>name=content</code> 适合匹配带有 <code>name</code> 属性的节点。</li>
          <li><strong>通过 <code>xpath</code> 定位：</strong> <code>xpath=//div[@class='main']/section[1]</code> 可精确指定多层结构；也可以在同一条规则中写更细的路径，例如 <code>xpath=//section[@id='main']//li[contains(@class,'item')]</code>。</li>
        </ul>
        <p class="mb-0">可在多行中混合不同方式，系统会使用第一条成功命中的区域。建议优先从外层容器开始，必要时再补充更细粒度的 XPath 或 CSS 选择器。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">我知道了</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
