{% extends 'base.html' %}
{% block content %}
{% set status_styles = {
  'running': ('warning', '执行中'),
  'success': ('success', '成功'),
  'completed': ('primary', '已完成'),
  'failed': ('danger', '失败'),
  'cancelled': ('secondary', '已终止')
} %}
<h2>监控记录</h2>
<form class="row g-3 mb-4" method="get">
  <div class="col-md-3">
    <label class="form-label">任务</label>
    <select class="form-select" name="task_id">
      <option value="">全部</option>
      {% for task in tasks %}
      <option value="{{ task.id }}" {% if query_args.task_id == task.id|string %}selected{% endif %}>{{ task.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">网站</label>
    <select class="form-select" name="website_id">
      <option value="">全部</option>
      {% for website in websites %}
      <option value="{{ website.id }}" {% if query_args.website_id == website.id|string %}selected{% endif %}>{{ website.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">状态</label>
    <select class="form-select" name="status">
      <option value="">全部</option>
      {% for key, label in status_choices.items() %}
      <option value="{{ key }}" {% if query_args.status == key %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">开始日期</label>
    <input type="datetime-local" class="form-control" name="start_date" value="{{ query_args.start_date }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">结束日期</label>
    <input type="datetime-local" class="form-control" name="end_date" value="{{ query_args.end_date }}">
  </div>
  <div class="col-md-3 align-self-end">
    <button class="btn btn-primary" type="submit">筛选</button>
  </div>
</form>
{% if logs %}
  {% for log in logs %}
  {% set status = status_styles.get(log.status, ('secondary', log.status or '未知')) %}
  <div class="card mb-3">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
      <div>
        <span class="badge text-bg-{{ status[0] }}">{{ status[1] }}</span>
        <span class="ms-2">任务：<strong>{{ log.task.name }}</strong></span>
        {% if log.task.website %}
        <span class="ms-2">网站：<a href="{{ log.task.website.url }}" target="_blank">{{ log.task.website.name }}</a></span>
        {% endif %}
      </div>
      <div class="small text-muted">日志编号：{{ log.id }}</div>
    </div>
    <div class="card-body">
      <p class="mb-1"><strong>开始时间：</strong> {{ log.run_started_at|format_datetime if log.run_started_at else '未知' }}</p>
      <p class="mb-1"><strong>结束时间：</strong> {{ log.run_finished_at|format_datetime if log.run_finished_at else '未结束' }}</p>
      <p class="text-muted">{{ log.message or '暂无汇总信息' }}</p>
      <h6 class="mt-3">日志明细</h6>
      <ul class="list-unstyled mb-3">
        {% for entry in log.entries[:5] %}
        <li class="mb-2">
          <span class="badge text-bg-secondary me-2">{{ entry.level|upper }}</span>
          <small class="text-muted me-2">{{ entry.created_at|format_datetime if entry.created_at else '' }}</small>
          {{ entry.message }}
        </li>
        {% else %}
        <li class="text-muted">暂无日志明细</li>
        {% endfor %}
      </ul>
      {% set remaining = log.entries|length - 5 %}
      {% if remaining > 0 %}
      <p class="small text-muted">还有 {{ remaining }} 条记录，可在任务详情中查看。</p>
      {% endif %}
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('view_task', task_id=log.task_id) }}#log-{{ log.id }}">查看完整日志</a>
    </div>
  </div>
  {% endfor %}
{% else %}
<div class="alert alert-secondary">暂无监控记录。</div>
{% endif %}
{% if total_pages > 1 %}
<nav>
  <ul class="pagination">
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('list_results', page=p, **query_args) }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>
{% endif %}
{% endblock %}
