{% extends 'base.html' %}
{% block content %}
{% set status_styles = {
  'running': ('warning', '执行中'),
  'success': ('success', '成功'),
  'completed': ('primary', '已完成'),
  'failed': ('danger', '失败')
} %}

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <h2 class="mb-0">任务详情 - {{ task.name }}</h2>
  <div class="d-flex flex-wrap gap-2">
    <form method="post" action="{{ url_for('run_task_now', task_id=task.id) }}">
      <button type="submit" class="btn btn-primary" {% if active_log %}disabled{% endif %}>立即执行任务</button>
    </form>
    <a class="btn btn-secondary" href="{{ url_for('list_tasks') }}">返回任务列表</a>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <div class="row gy-3">
      <div class="col-lg-6">
        <h5 class="card-title">基本信息</h5>
        <p class="mb-1"><strong>网站：</strong> {{ task.website.name if task.website else '未配置' }}</p>
        <p class="mb-1"><strong>URL：</strong>
          {% if task.website %}
            <a href="{{ task.website.url }}" target="_blank">{{ task.website.url }}</a>
          {% else %}
            未配置
          {% endif %}
        </p>
        {% if task.website and task.website.last_snapshot %}
        <p class="mb-1"><a href="{{ url_for('view_website_snapshot', website_id=task.website.id) }}" class="link-primary">查看最近抓取快照</a></p>
        {% endif %}
        <p class="mb-1"><strong>关注内容：</strong>
          {% if task.watch_contents %}
            {% for content in task.watch_contents %}
              <span class="badge text-bg-secondary me-1 mb-1">{{ content.text }}</span>
            {% endfor %}
          {% else %}
            无
          {% endif %}
        </p>
        <p class="mb-0"><strong>相似度阈值：</strong> {{ threshold }}</p>
      </div>
      <div class="col-lg-6">
        <h5 class="card-title">执行与通知</h5>
        <p class="mb-1"><strong>任务状态：</strong> {{ '运行中' if task.is_active else '已暂停' }}</p>
        <p class="mb-1"><strong>最近执行状态：</strong> {{ status_styles.get(task.last_status, ('secondary', task.last_status or '无'))[1] }}</p>
        <p class="mb-1"><strong>最近执行时间：</strong> {{ task.last_run_at|format_datetime or '无' }}</p>
        {% if next_run_at %}
        <p class="mb-1"><strong>下一次执行时间：</strong> {{ next_run_at|format_datetime }}</p>
        {% elif task.is_active and not active_log %}
        <p class="mb-1 text-muted"><strong>下一次执行时间：</strong> 调度将在配置的间隔内自动安排</p>
        {% endif %}
        {% if task.notification_method == 'dingtalk' %}
        <p class="mb-1"><strong>通知方式：</strong> 钉钉群机器人</p>
        {% else %}
        <p class="mb-1"><strong>通知方式：</strong> 邮件</p>
        <p class="mb-0"><strong>通知邮箱：</strong> {{ task.notification_email or '未配置' }}</p>
        {% endif %}
      </div>
    </div>
    {% if active_log %}
    <div class="alert alert-warning mt-3 mb-0" role="alert">
      任务正在执行中，日志将实时更新。
    </div>
    {% endif %}
  </div>
</div>

<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
  <h3 class="h5 mb-0">执行日志</h3>
  <div class="d-flex flex-wrap align-items-center gap-2 small text-muted">
    <span>共 {{ total_logs }} 条</span>
    <form class="row row-cols-lg-auto g-2 align-items-end" method="post" action="{{ url_for('bulk_delete_task_logs', task_id=task.id) }}">
      <input type="hidden" name="current_page" value="{{ page }}">
      <div class="col">
        <label class="form-label mb-0">删除此时间及之前的日志</label>
        <input type="datetime-local" class="form-control form-control-sm" name="cutoff" required>
      </div>
      <div class="col">
        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('确定删除选定时间之前的日志吗？');">批量删除</button>
      </div>
    </form>
  </div>
</div>
{% if logs %}
  <div class="accordion" id="logAccordion">
    {% for log in logs %}
      {% set status = status_styles.get(log.status, ('secondary', log.status or '未知')) %}
      {% set is_running = active_log and log.id == active_log.id %}
      <div class="accordion-item" id="log-{{ log.id }}" data-log-id="{{ log.id }}" {% if is_running %}data-log-running="true" data-fetch-url="{{ url_for('stream_task_log_entries', task_id=task.id, log_id=log.id) }}"{% endif %}>
        <h2 class="accordion-header" id="heading-{{ log.id }}">
          <button class="accordion-button {% if not is_running %}collapsed{% endif %} py-2" type="button" data-bs-toggle="collapse" data-bs-target="#log-body-{{ log.id }}" aria-expanded="{{ 'true' if is_running else 'false' }}" aria-controls="log-body-{{ log.id }}">
            <div class="d-flex flex-grow-1 flex-wrap align-items-center gap-2">
              <span class="badge text-bg-{{ status[0] }}" data-log-status>{{ status[1] }}</span>
              <span class="text-muted small">编号：{{ log.id }}</span>
              <span class="text-muted small">开始：{{ log.run_started_at|format_datetime or '未知' }}</span>
              <span class="text-muted small">结束：<span data-log-finished>{{ log.run_finished_at|format_datetime or (log.status == 'running' and '进行中' or '未知') }}</span></span>
              <span class="text-muted small text-truncate">{{ log.message or '暂无汇总信息' }}</span>
            </div>
          </button>
        </h2>
        <div id="log-body-{{ log.id }}" class="accordion-collapse collapse {% if is_running %}show{% endif %}" aria-labelledby="heading-{{ log.id }}" data-bs-parent="#logAccordion">
          <div class="accordion-body">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
              <p class="text-muted mb-0 flex-grow-1" data-log-message>{{ log.message or '暂无汇总信息' }}</p>
              <form method="post" action="{{ url_for('delete_task_log', task_id=task.id, log_id=log.id) }}" class="ms-auto">
                <input type="hidden" name="current_page" value="{{ page }}">
                <button type="submit" class="btn btn-sm btn-outline-danger" {% if is_running %}disabled title="执行中的日志暂时无法删除"{% else %}onclick="return confirm('确定删除该执行日志吗？');"{% endif %}>删除此日志</button>
              </form>
            </div>
            <ul class="list-unstyled mb-0 log-entry-list">
              {% for entry in log.entries %}
              <li class="mb-2" data-entry-id="{{ entry.id }}">
                <span class="badge text-bg-secondary me-2">{{ entry.level|upper }}</span>
                <small class="text-muted me-2">{{ entry.created_at|format_datetime }}</small>
                {{ entry.message }}
              </li>
              {% else %}
              <li class="text-muted" data-empty-log>暂无日志明细</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% if total_pages > 1 %}
  <nav aria-label="日志分页" class="mt-3">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('view_task', task_id=task.id, page=page-1) }}" tabindex="-1">上一页</a>
      </li>
      {% for p in range(1, total_pages + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ url_for('view_task', task_id=task.id, page=p) }}">{{ p }}</a></li>
      {% endfor %}
      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for('view_task', task_id=task.id, page=page+1) }}">下一页</a>
      </li>
    </ul>
  </nav>
  {% endif %}
{% else %}
  <div class="alert alert-secondary">暂无执行日志。</div>
{% endif %}

<h3 class="h5 mt-4">最近匹配结果</h3>
<table class="table table-striped">
  <thead>
    <tr>
      <th>时间</th>
      <th>标题</th>
      <th>链接</th>
      <th>匹配关注项</th>
      <th>相似度</th>
    </tr>
  </thead>
  <tbody>
    {% for result in results %}
    <tr>
      <td>{{ result.created_at|format_datetime }}</td>
      <td>{{ result.link_title or '无标题' }}</td>
      <td><a href="{{ result.discovered_url }}" target="_blank">打开</a></td>
      <td>{{ result.content.text if result.content else '未知' }}</td>
      <td>{{ '%.2f'|format(result.similarity_score or 0) }}</td>
    </tr>
    {% else %}
    <tr>
      <td colspan="5" class="text-center text-muted">暂无匹配结果</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<a class="btn btn-secondary" href="{{ url_for('list_tasks') }}">返回任务列表</a>

{% if active_log %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const logCard = document.querySelector('[data-log-running="true"]');
    if (!logCard) {
      return;
    }

    const entryList = logCard.querySelector('.log-entry-list');
    const statusBadge = logCard.querySelector('[data-log-status]');
    const messageEl = logCard.querySelector('[data-log-message]');
    const finishedEl = logCard.querySelector('[data-log-finished]');
    const fetchUrl = logCard.getAttribute('data-fetch-url');
    const statusMap = {
      running: {cls: 'warning', text: '执行中'},
      success: {cls: 'success', text: '成功'},
      completed: {cls: 'primary', text: '已完成'},
      failed: {cls: 'danger', text: '失败'}
    };

    let lastEntryId = 0;
    entryList.querySelectorAll('[data-entry-id]').forEach(function (item) {
      const id = parseInt(item.getAttribute('data-entry-id'), 10);
      if (id > lastEntryId) {
        lastEntryId = id;
      }
    });

    function appendEntry(entry) {
      if (entryList.querySelector('[data-entry-id="' + entry.id + '"]')) {
        return;
      }
      const emptyPlaceholder = entryList.querySelector('[data-empty-log]');
      if (emptyPlaceholder) {
        emptyPlaceholder.remove();
      }
      const li = document.createElement('li');
      li.className = 'mb-2';
      li.setAttribute('data-entry-id', entry.id);
      li.innerHTML = '<span class="badge text-bg-secondary me-2">' + entry.level.toUpperCase() + '</span>' +
        '<small class="text-muted me-2">' + (entry.created_at || '') + '</small>' +
        entry.message;
      entryList.appendChild(li);
    }

    function updateStatus(status) {
      const info = statusMap[status];
      if (!info || !statusBadge) {
        return;
      }
      statusBadge.className = 'badge text-bg-' + info.cls;
      statusBadge.textContent = info.text;
    }

    function poll() {
      const url = lastEntryId ? fetchUrl + '?after=' + lastEntryId : fetchUrl;
      fetch(url)
        .then(function (response) { return response.json(); })
        .then(function (data) {
          if (Array.isArray(data.entries)) {
            data.entries.forEach(function (entry) {
              appendEntry(entry);
              if (entry.id > lastEntryId) {
                lastEntryId = entry.id;
              }
            });
          }
          if (data.message && messageEl) {
            messageEl.textContent = data.message;
          }
          if (data.status && data.status !== 'running') {
            updateStatus(data.status);
            if (finishedEl && data.run_finished_at) {
              finishedEl.textContent = data.run_finished_at;
            }
            clearInterval(timer);
          }
        })
        .catch(function (error) {
          console.error('日志刷新失败', error);
        });
    }

    const timer = setInterval(poll, 3000);
    poll();
  });
</script>
{% endif %}
{% endblock %}
