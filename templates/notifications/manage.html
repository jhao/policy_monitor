{% extends 'base.html' %}
{% block content %}
<h2>通知配置</h2>
<p class="text-muted">在此管理邮件和钉钉通知的全局配置，供监控任务使用。</p>
<div class="row">
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">SMTP 邮件配置</div>
      <div class="card-body">
        <form method="post" class="d-grid gap-3">
          <input type="hidden" name="config_type" value="email">
          <div class="mb-3">
            <label class="form-label">SMTP 主机</label>
            <input type="text" class="form-control" name="smtp_host" value="{{ email_setting.smtp_host if email_setting else '' }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">SMTP 端口</label>
            <input type="number" class="form-control" name="smtp_port" value="{{ email_setting.smtp_port if email_setting and email_setting.smtp_port else 587 }}" min="1">
          </div>
          <div class="mb-3">
            <label class="form-label">用户名</label>
            <input type="text" class="form-control" name="smtp_username" value="{{ email_setting.smtp_username if email_setting else '' }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">密码 / 授权码</label>
            <input type="password" class="form-control" name="smtp_password" value="{{ email_setting.smtp_password if email_setting else '' }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">发件人地址</label>
            <input type="email" class="form-control" name="smtp_sender" value="{{ email_setting.smtp_sender if email_setting else '' }}">
            <div class="form-text">若为空则默认使用用户名。</div>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="smtpUseTls" name="smtp_use_tls" {% if not email_setting or email_setting.smtp_use_tls %}checked{% endif %}>
            <label class="form-check-label" for="smtpUseTls">启用 TLS</label>
          </div>
          <div class="mb-3">
            <label class="form-label">测试收件人（可选）</label>
            <input type="email" class="form-control" name="test_recipient" placeholder="未填写则默认使用发件人地址">
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit" name="action" value="save">保存 SMTP 配置</button>
            <button class="btn btn-outline-secondary" type="submit" name="action" value="test">发送测试邮件</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">钉钉机器人配置</div>
      <div class="card-body">
        <form method="post" class="d-grid gap-3">
          <input type="hidden" name="config_type" value="dingtalk">
          <div class="mb-3">
            <label class="form-label">Webhook 地址</label>
            <input type="url" class="form-control" name="webhook_url" value="{{ dingtalk_setting.webhook_url if dingtalk_setting else '' }}" required>
          </div>
          <div class="form-text">请使用钉钉群机器人提供的自定义机器人 webhook 地址。</div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit" name="action" value="save">保存钉钉配置</button>
            <button class="btn btn-outline-secondary" type="submit" name="action" value="test">发送测试通知</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-2">
      <span>发送日志</span>
      <span class="badge text-bg-secondary">共 {{ log_total }} 条</span>
    </div>
    <button type="submit" form="notificationLogForm" class="btn btn-sm btn-outline-danger" id="deleteLogsButton" onclick="return confirm('确定删除选中的通知日志吗？');" {% if not notification_logs %}disabled{% endif %}>删除选中</button>
  </div>
  <form id="notificationLogForm" method="post" action="{{ url_for('delete_notification_logs') }}">
    <input type="hidden" name="current_page" value="{{ log_page }}">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped mb-0 align-middle">
          <thead>
            <tr>
              <th scope="col" class="text-center" style="width: 4%;">
                <input class="form-check-input" type="checkbox" id="selectAllLogs" {% if not notification_logs %}disabled{% endif %}>
              </th>
              <th scope="col" style="width: 18%;">时间</th>
              <th scope="col" style="width: 15%;">渠道</th>
              <th scope="col">目标</th>
              <th scope="col" style="width: 10%;">状态</th>
              <th scope="col">详情</th>
            </tr>
          </thead>
          <tbody>
            {% for log in notification_logs %}
            <tr>
              <td class="text-center">
                <input class="form-check-input log-checkbox" type="checkbox" name="log_ids" value="{{ log.id }}">
              </td>
              <td>{{ log.created_at|format_datetime or '未知' }}</td>
              <td>{{ '邮件' if log.channel == 'email' else '钉钉' }}</td>
              <td class="text-truncate" style="max-width: 260px;" title="{{ log.target }}">{{ log.target or '未提供' }}</td>
              <td>
                {% if log.status == 'success' %}
                <span class="badge text-bg-success">成功</span>
                {% elif log.status == 'failed' %}
                <span class="badge text-bg-danger">失败</span>
                {% else %}
                <span class="badge text-bg-secondary">{{ log.status }}</span>
                {% endif %}
              </td>
              <td>
                {% if log.message or log.payload %}
                <button
                  type="button"
                  class="btn btn-link p-0 align-baseline"
                  data-bs-toggle="modal"
                  data-bs-target="#logMessageModal"
                  data-message="{{ (log.message or '')|e }}"
                  data-payload='{{ log.payload|tojson|safe }}'
                  data-channel-label="{{ '邮件' if log.channel == 'email' else '钉钉' }}"
                  data-status-label="{{ '成功' if log.status == 'success' else '失败' if log.status == 'failed' else log.status }}"
                  data-target="{{ (log.target or '')|e }}"
                  data-created-at="{{ log.created_at|format_datetime or '' }}"
                  title="点击查看详情"
                >
                  {% if log.message %}
                  {{ log.message|truncate(32, True, '…') }}
                  {% else %}
                  查看内容
                  {% endif %}
                </button>
                {% else %}
                —
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">暂无发送记录</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </form>
  {% if log_total_pages > 1 %}
  <div class="card-footer">
    <nav aria-label="发送日志分页">
      <ul class="pagination justify-content-center mb-0">
        <li class="page-item {% if log_page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('manage_notifications', page=log_page-1) }}" tabindex="-1">上一页</a>
        </li>
        {% for p in range(1, log_total_pages + 1) %}
        <li class="page-item {% if p == log_page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('manage_notifications', page=p) }}">{{ p }}</a>
        </li>
        {% endfor %}
        <li class="page-item {% if log_page >= log_total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('manage_notifications', page=log_page+1) }}">下一页</a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}
</div>

<div class="modal fade" id="logMessageModal" tabindex="-1" aria-labelledby="logMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logMessageModalLabel">通知详情</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted small" id="logMessageModalMeta"></p>
        <div id="logMessageContainer" class="mb-3 d-none">
          <h6 class="fw-semibold">状态说明</h6>
          <pre id="logMessageModalBody" class="bg-light border rounded p-3 mb-0" style="white-space: pre-wrap;"></pre>
        </div>
        <div id="logPayloadContainer" class="d-none">
          <h6 class="fw-semibold">发送内容预览</h6>
          <div id="logPayloadPreview" class="border rounded bg-white"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var messageModal = document.getElementById('logMessageModal');
    if (!messageModal) {
      return;
    }
    messageModal.addEventListener('show.bs.modal', function (event) {
      var trigger = event.relatedTarget;
      var modalTitle = messageModal.querySelector('.modal-title');
      var modalMeta = document.getElementById('logMessageModalMeta');
      var modalBody = document.getElementById('logMessageModalBody');
      var messageContainer = document.getElementById('logMessageContainer');
      var payloadContainer = document.getElementById('logPayloadContainer');
      var payloadPreview = document.getElementById('logPayloadPreview');
      var message = trigger ? trigger.getAttribute('data-message') || '' : '';
      var rawPayload = trigger ? trigger.getAttribute('data-payload') || '' : '';
      var channelLabel = trigger ? trigger.getAttribute('data-channel-label') || '' : '';
      var statusLabel = trigger ? trigger.getAttribute('data-status-label') || '' : '';
      var target = trigger ? trigger.getAttribute('data-target') || '' : '';
      var createdAt = trigger ? trigger.getAttribute('data-created-at') || '' : '';
      modalTitle.textContent = '通知详情';
      var metaItems = [];
      if (createdAt) metaItems.push('时间：' + createdAt);
      if (channelLabel) metaItems.push('渠道：' + channelLabel);
      if (statusLabel) metaItems.push('状态：' + statusLabel);
      if (target) metaItems.push('目标：' + target);
      modalMeta.textContent = metaItems.join(' · ');
      if (messageContainer) {
        if (message) {
          messageContainer.classList.remove('d-none');
          modalBody.textContent = message;
        } else {
          messageContainer.classList.add('d-none');
          modalBody.textContent = '';
        }
      }

      if (payloadContainer && payloadPreview) {
        payloadContainer.classList.add('d-none');
        payloadPreview.innerHTML = '';
        if (rawPayload && rawPayload !== 'null') {
          var parsedPayload = null;
          try {
            var payloadString = JSON.parse(rawPayload);
            if (payloadString) {
              try {
                parsedPayload = JSON.parse(payloadString);
              } catch (innerErr) {
                parsedPayload = payloadString;
              }
            }
          } catch (err) {
            parsedPayload = null;
          }

          if (parsedPayload) {
            payloadContainer.classList.remove('d-none');
            if (typeof parsedPayload === 'object' && !Array.isArray(parsedPayload)) {
              if (parsedPayload.recipients && parsedPayload.recipients.length) {
                var recipientsEl = document.createElement('p');
                recipientsEl.className = 'small text-muted mb-2';
                recipientsEl.textContent = '收件人：' + parsedPayload.recipients.join(', ');
                payloadPreview.appendChild(recipientsEl);
              }
              if (parsedPayload.format === 'email' && parsedPayload.html) {
                var iframe = document.createElement('iframe');
                iframe.className = 'w-100 border';
                iframe.style.minHeight = '240px';
                iframe.setAttribute('sandbox', '');
                iframe.srcdoc = parsedPayload.html;
                payloadPreview.appendChild(iframe);
              } else {
                var pre = document.createElement('pre');
                pre.className = 'mb-0 bg-light border rounded p-3';
                pre.style.whiteSpace = 'pre-wrap';
                pre.textContent = JSON.stringify(parsedPayload, null, 2);
                payloadPreview.appendChild(pre);
              }
            } else {
              var textPre = document.createElement('pre');
              textPre.className = 'mb-0 bg-light border rounded p-3';
              textPre.style.whiteSpace = 'pre-wrap';
              textPre.textContent = String(parsedPayload);
              payloadPreview.appendChild(textPre);
            }
          }
        }
      }
    });

    var logForm = document.getElementById('notificationLogForm');
    var deleteButton = document.getElementById('deleteLogsButton');
    var selectAll = document.getElementById('selectAllLogs');
    var checkboxList = logForm ? Array.prototype.slice.call(logForm.querySelectorAll('.log-checkbox')) : [];

    function updateDeleteState() {
      if (!deleteButton) {
        return;
      }
      var anyChecked = checkboxList.some(function (item) { return item.checked; });
      deleteButton.disabled = !anyChecked;
    }

    if (selectAll && checkboxList.length) {
      selectAll.addEventListener('change', function () {
        var checked = selectAll.checked;
        checkboxList.forEach(function (item) {
          item.checked = checked;
        });
        updateDeleteState();
      });
    }

    checkboxList.forEach(function (checkbox) {
      checkbox.addEventListener('change', function () {
        if (selectAll && !checkbox.checked) {
          selectAll.checked = false;
        } else if (selectAll && checkboxList.every(function (item) { return item.checked; })) {
          selectAll.checked = true;
        }
        updateDeleteState();
      });
    });

    updateDeleteState();
  });
</script>
{% endblock %}
