{% extends 'base.html' %}
{% block content %}
<h2>通知配置</h2>
<p class="text-muted">在此管理邮件和钉钉通知的全局配置，供监控任务使用。</p>
<div class="row">
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">SMTP 邮件配置</div>
      <div class="card-body">
        <form method="post" class="d-grid gap-3">
          <input type="hidden" name="config_type" value="email">
          <div class="mb-3">
            <label class="form-label">SMTP 主机</label>
            <input type="text" class="form-control" name="smtp_host" value="{{ email_setting.smtp_host if email_setting else '' }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">SMTP 端口</label>
            <input type="number" class="form-control" name="smtp_port" value="{{ email_setting.smtp_port if email_setting and email_setting.smtp_port else 587 }}" min="1">
          </div>
          <div class="mb-3">
            <label class="form-label">用户名</label>
            <input type="text" class="form-control" name="smtp_username" value="{{ email_setting.smtp_username if email_setting else '' }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">密码 / 授权码</label>
            <input type="password" class="form-control" name="smtp_password" value="{{ email_setting.smtp_password if email_setting else '' }}" required>
          </div>
          <div class="mb-3">
            <label class="form-label">发件人地址</label>
            <input type="email" class="form-control" name="smtp_sender" value="{{ email_setting.smtp_sender if email_setting else '' }}">
            <div class="form-text">若为空则默认使用用户名。</div>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="smtpUseTls" name="smtp_use_tls" {% if not email_setting or email_setting.smtp_use_tls %}checked{% endif %}>
            <label class="form-check-label" for="smtpUseTls">启用 TLS</label>
          </div>
          <div class="mb-3">
            <label class="form-label">测试收件人（可选）</label>
            <input type="email" class="form-control" name="test_recipient" placeholder="未填写则默认使用发件人地址">
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit" name="action" value="save">保存 SMTP 配置</button>
            <button class="btn btn-outline-secondary" type="submit" name="action" value="test">发送测试邮件</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">钉钉机器人配置</div>
      <div class="card-body">
        <form method="post" class="d-grid gap-3">
          <input type="hidden" name="config_type" value="dingtalk">
          <div class="mb-3">
            <label class="form-label">Webhook 地址</label>
            <input type="url" class="form-control" name="webhook_url" value="{{ dingtalk_setting.webhook_url if dingtalk_setting else '' }}" required>
          </div>
          <div class="form-text">请使用钉钉群机器人提供的自定义机器人 webhook 地址。</div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit" name="action" value="save">保存钉钉配置</button>
            <button class="btn btn-outline-secondary" type="submit" name="action" value="test">发送测试通知</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>发送日志</span>
    <span class="badge text-bg-secondary">共 {{ log_total }} 条</span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped mb-0">
        <thead>
          <tr>
            <th scope="col" style="width: 20%;">时间</th>
            <th scope="col" style="width: 15%;">渠道</th>
            <th scope="col">目标</th>
            <th scope="col" style="width: 10%;">状态</th>
            <th scope="col">说明</th>
          </tr>
        </thead>
        <tbody>
          {% for log in notification_logs %}
          <tr>
            <td>{{ log.created_at|format_datetime or '未知' }}</td>
            <td>{{ '邮件' if log.channel == 'email' else '钉钉' }}</td>
            <td class="text-truncate" style="max-width: 260px;" title="{{ log.target }}">{{ log.target or '未提供' }}</td>
            <td>
              {% if log.status == 'success' %}
              <span class="badge text-bg-success">成功</span>
              {% elif log.status == 'failed' %}
              <span class="badge text-bg-danger">失败</span>
              {% else %}
              <span class="badge text-bg-secondary">{{ log.status }}</span>
              {% endif %}
            </td>
            <td>{{ log.message or '—' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="5" class="text-center text-muted py-4">暂无发送记录</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% if log_total_pages > 1 %}
  <div class="card-footer">
    <nav aria-label="发送日志分页">
      <ul class="pagination justify-content-center mb-0">
        <li class="page-item {% if log_page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('manage_notifications', page=log_page-1) }}" tabindex="-1">上一页</a>
        </li>
        {% for p in range(1, log_total_pages + 1) %}
        <li class="page-item {% if p == log_page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('manage_notifications', page=p) }}">{{ p }}</a>
        </li>
        {% endfor %}
        <li class="page-item {% if log_page >= log_total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('manage_notifications', page=log_page+1) }}">下一页</a>
        </li>
      </ul>
    </nav>
  </div>
  {% endif %}
</div>
{% endblock %}
